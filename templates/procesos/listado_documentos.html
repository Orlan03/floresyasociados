{# templates/procesos/documentos.html #}
{% extends "base.html" %}
{% block title %}Documentos{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
  :root{
    --navy-900:#071534; --navy-800:#0B1E44; --navy-700:#112759;
    --ink:#EAF0FF; --muted:#9FB0D6;
    --gold-1:#F7D67B; --gold-2:#DCA94F; --gold-3:#B17B2E;
    --border:rgba(255,255,255,.08);
    --shadow:0 10px 40px rgba(0,0,0,.35);
    --rad:16px;
  }
  body{ background: radial-gradient(1600px 900px at 10% -10%, #132654 0%, var(--navy-900) 60%); color:var(--ink); }
  .wrap{ max-width:1180px; margin:40px auto; padding:0 24px; }

  /* Header */
  .hdr{ display:flex; align-items:center; justify-content:space-between; gap:14px; margin-bottom:18px; }
  .titlebox{ display:flex; align-items:center; gap:12px; }
  .title-ico{ width:44px; height:44px; border-radius:12px; display:grid; place-items:center;
              background:rgba(255,255,255,.08); color:var(--gold-1); border:1px solid var(--border); }
  .crumbs{ color:var(--muted); font-size:.9rem; display:flex; gap:8px; align-items:center; }
  .crumbs a{ color:var(--gold-1); text-decoration:none; }
  .title{ margin:0; font-size:1.4rem; font-weight:800; color:#fff; }

  .btn{
    display:inline-flex; align-items:center; gap:8px; border-radius:12px; padding:10px 14px;
    cursor:pointer; text-decoration:none; font-weight:800;
    border:1px solid var(--border); background:rgba(255,255,255,.05); color:var(--ink);
    transition:all .15s ease;
  }
  .btn:hover{ background:rgba(255,255,255,.1); transform:translateY(-1px); }
  .btn.primary{ border:0; background:linear-gradient(90deg,var(--gold-1),var(--gold-2)); color:#1a1a1a;
                box-shadow:0 8px 24px rgba(220,169,79,.25); }
  .btn.primary:hover{ background:linear-gradient(90deg,var(--gold-2),var(--gold-3)); }
  .btn.icon{ width:40px; height:40px; justify-content:center; }

  /* Toolbar */
  .toolbar{
    background:rgba(255,255,255,.06); border:1px solid var(--border); border-radius:var(--rad);
    box-shadow:var(--shadow); padding:14px; display:flex; flex-wrap:wrap; align-items:center;
    justify-content:space-between; margin-bottom:20px;
  }
  .search{ display:flex; align-items:center; gap:8px; background:rgba(255,255,255,.05);
           border:1.5px solid var(--border); border-radius:10px; padding:10px 12px; min-width:280px; color:#fff; }
  .search input{ border:0; outline:none; width:100%; background:transparent; color:var(--ink); font-size:1rem; }
  .select{ background:rgba(255,255,255,.05); color:var(--ink); border:1.5px solid var(--border);
           border-radius:10px; padding:10px 12px; font-weight:600; }

  /* Grid */
  .card{ background:rgba(255,255,255,.05); border:1px solid var(--border); border-radius:var(--rad);
         padding:16px; box-shadow:var(--shadow); }
  .grid{ display:grid; gap:18px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
  .folder{ background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:12px; padding:16px; transition:all .2s ease; }
  .folder:hover{ transform:translateY(-3px); box-shadow:0 10px 28px rgba(247,214,123,.25); border-color:rgba(247,214,123,.4); }
  .f-head{ display:flex; align-items:center; justify-content:space-between; }
  .f-name{ display:flex; align-items:center; gap:10px; color:var(--gold-1); font-weight:800; text-decoration:none; }
  .badges{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
  .badge{ display:inline-flex; align-items:center; gap:6px; background:rgba(255,255,255,.08);
          border:1px solid var(--border); border-radius:999px; padding:6px 10px; color:var(--ink); font-size:.85rem; }
  .badge i{ color:var(--gold-1); }

  .empty{text-align:center; color:var(--muted); padding:36px 10px;}
  .empty i{ font-size:46px; color:var(--gold-1); }

  /* Modal base (crear carpeta y subir doc comparten) */
  .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); align-items:center; justify-content:center; z-index:50; }
  .modal-card{ width:min(560px,90%); background:#fff; color:#111; border-radius:16px; padding:20px;
               box-shadow:0 20px 60px rgba(0,0,0,.5); }
  .modal h3{ margin:0 0 8px; color:#1a1a1a; }
  .modal p{ color:#555; margin:0 0 12px; }
  .field{ width:100%; border:1.5px solid #ccc; border-radius:10px; padding:10px; }
  .modal-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:12px; }

  /* Dropzone subir doc */
  .dropzone{
    position:relative; border:1.5px dashed #ccc; border-radius:14px; padding:18px;
    background:#fafafa; color:#222; transition:border-color .12s ease, background .12s ease; cursor:pointer;
  }
  .dropzone.dragover{ border-color:#111; background:#f0f0f0; }
  .dz-inner{ display:flex; gap:14px; align-items:center; justify-content:flex-start; flex-wrap:wrap; }
  .dz-icon{ width:42px; height:42px; display:grid; place-items:center; border-radius:12px; background:#111; color:#fff; font-weight:900; }
  .dz-text{ color:#111; }
  .dz-sub{ color:#555; font-size:.92rem; }
  .file-meta{ margin-top:8px; color:#444; }
</style>

<div class="wrap">
  <!-- Header -->
  <div class="hdr">
    <div class="titlebox">
      <div class="title-ico"><i class="fa fa-folder"></i></div>
      <div>
        <div class="crumbs">
          <a href="{% url 'dashboard' %}">Inicio</a> <i class="fa fa-angle-right"></i> <span>Documentos</span>
        </div>
        <h2 class="title">Documentos</h2>
      </div>
    </div>
    <a class="btn" href="{% url 'procesos:lista' %}"><i class="fa fa-briefcase"></i> Ir a procesos</a>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <form class="search" action="{% url 'procesos:documentos_buscar' %}" method="get"
              onsubmit="return !!this.q.value.trim();">
          <i class="fa fa-search"></i>
          <input
            type="search"
            name="q"
            placeholder="Buscar carpetas y documentos…"
            oninput="filterCards(this.value)"
            aria-label="Buscar carpetas y documentos"
            required
          >
          <button class="btn primary" type="submit">Buscar</button>
        </form>

        <select class="select" id="orderSelect" onchange="orderCards(this.value)">
          <option value="az">Ordenar: A → Z</option>
          <option value="za">Ordenar: Z → A</option>
        </select>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="btnSubirDoc" class="btn"><i class="fa fa-upload"></i> Subir documento</button>
        <button id="btnNuevaRaiz" class="btn primary"><i class="fa fa-folder-plus"></i> Nueva carpeta</button>
      </div>
</div>

  <!-- Grid -->
  <div class="card">
    {% if raiz %}
      <div id="folderGrid" class="grid">
        {% for c in raiz %}
          <div class="folder" data-name="{{ c.nombre|lower }}">
            <div class="f-head">
              <a class="f-name" href="{% url 'procesos:carpeta_detalle' c.id %}">
                <i class="fa fa-folder"></i> {{ c.nombre }}
              </a>
              <button class="btn icon" data-action="sub" data-id="{{ c.id }}" title="Crear subcarpeta">
                <i class="fa fa-plus"></i>
              </button>
            </div>
            <div class="badges">
              <span class="badge"><i class="fa fa-sitemap"></i> {{ c.cant_subs }} subcarpeta{{ c.cant_subs|pluralize }}</span>
              <span class="badge"><i class="fa fa-file-lines"></i> {{ c.documentos.count }} item{{ c.documentos.count|pluralize }}</span>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty">
        <i class="fa fa-folder-open"></i>
        <p>No hay carpetas documentales. Crea la primera.</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Modal crear carpeta -->
<div id="modal" class="modal">
  <div class="modal-card">
    <h3>Nueva carpeta (Documentos)</h3>
    <p>Asigna un nombre claro y consistente.</p>
    <form method="post" action="{% url 'procesos:crear_carpeta' %}">
      {% csrf_token %}
      <input type="hidden" name="seccion" value="documentos">
      <input type="hidden" name="padre" id="padre">
      <input type="hidden" name="next" value="{{ request.get_full_path }}">
      <input class="field" type="text" name="nombre" placeholder="Ej. Contratos 2025" required>
      <div class="modal-actions">
        <button type="button" class="btn" data-close>Cancelar</button>
        <button class="btn primary" type="submit">Crear</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal subir documento -->
<div id="modalUpload" class="modal">
  <div class="modal-card">
    <h3 style="margin:0 0 6px;">Subir documento</h3>
    <p style="margin:0 0 12px;color:#555;">Elige la carpeta destino, nombra tu archivo y selecciónalo.</p>

    <form id="formUpload" method="post" action="{% url 'procesos:subir_documento' %}" enctype="multipart/form-data" novalidate>
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.get_full_path }}">

      <!-- Carpeta destino -->
      <label style="font-weight:700;display:block;margin:8px 0 6px;">Carpeta destino</label>
      <select class="field" name="carpeta" id="selCarpeta" required>
        <option value="">— Selecciona carpeta —</option>
        {% for c in raiz %}
          <option value="{{ c.id }}">{{ c.nombre }}</option>
        {% endfor %}
      </select>

      <!-- Nombre del documento -->
      <label style="font-weight:700;display:block;margin:12px 0 6px;">Nombre del documento</label>
      <input class="field" type="text" id="nombreDoc" name="nombre" placeholder="Ej. Contrato_Cliente_2025" required>

      <!-- Dropzone / Selector de archivo -->
      <label style="font-weight:700;display:block;margin:12px 0 6px;">Archivo</label>
      <div id="dzUpload" class="dropzone">
        <div class="dz-inner">
          <div class="dz-icon"><i class="fa fa-upload"></i></div>
          <div>
            <div class="dz-text"><strong>Arrastra y suelta aquí</strong> o haz clic para seleccionar</div>
            <div class="dz-sub">PDF, DOCX, JPG, PNG (según configuración del sistema)</div>
          </div>
        </div>
        <div id="dzMeta" class="file-meta" style="display:none;"></div>
      </div>

      <!-- Input de archivo real (oculto visualmente) -->
      <input type="file" id="fileReal" name="archivo"
             style="height:0;overflow:hidden;opacity:0;position:absolute;"
             accept=".pdf,.doc,.docx,.png,.jpg,.jpeg" required>

      <div class="modal-actions">
        <button type="button" class="btn" data-close-upload>Cancelar</button>
        <button class="btn primary" type="submit"><i class="fa fa-cloud-arrow-up"></i> Subir</button>
      </div>
    </form>
  </div>
</div>

<script>
  // ----- Modal crear carpeta -----
  const modal = document.getElementById('modal');
  const padre = document.getElementById('padre');

  document.getElementById('btnNuevaRaiz')?.addEventListener('click', e=>{
    e.preventDefault(); padre.value=''; modal.style.display='flex';
  });

  document.querySelectorAll('[data-action="sub"]').forEach(b=>{
    b.addEventListener('click', e=>{
      e.preventDefault(); padre.value=b.dataset.id; modal.style.display='flex';
    });
  });

  function closeModal(){ modal.style.display='none'; }
  document.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click', closeModal));
  modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

  // ----- Filtro + orden -----
  function filterCards(q){
    q=(q||'').trim().toLowerCase();
    document.querySelectorAll('#folderGrid .folder').forEach(card=>{
      const name=card.dataset.name||'';
      card.style.display = name.includes(q) ? '' : 'none';
    });
  }
  function orderCards(mode){
    const grid=document.getElementById('folderGrid');
    if(!grid) return;
    const nodes=[...grid.children];
    nodes.sort((a,b)=>{
      const na=(a.dataset.name||'').localeCompare(b.dataset.name||'','es',{sensitivity:'base'});
      return mode==='za' ? -na : na;
    });
    nodes.forEach(n=>grid.appendChild(n));
  }

  // ----- Modal subir documento -----
  const modalUpload = document.getElementById('modalUpload');
  const btnSubirDoc = document.getElementById('btnSubirDoc');
  const closeUploadButtons = document.querySelectorAll('[data-close-upload]');
  const dzUpload = document.getElementById('dzUpload');
  const fileReal = document.getElementById('fileReal');
  const dzMeta = document.getElementById('dzMeta');
  const nombreDoc = document.getElementById('nombreDoc');

  function openUploadModal(){ modalUpload.style.display='flex'; }
  function closeUploadModal(){ modalUpload.style.display='none'; }

  btnSubirDoc?.addEventListener('click', e=>{ e.preventDefault(); openUploadModal(); });
  closeUploadButtons.forEach(b=>b.addEventListener('click', closeUploadModal));
  modalUpload.addEventListener('click', e=>{ if(e.target===modalUpload) closeUploadModal(); });
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeUploadModal(); });

  // Click en dropzone abre el input real
  dzUpload?.addEventListener('click', ()=> fileReal.click());

  // Drag & drop visual
  ['dragenter','dragover'].forEach(ev=>{
    dzUpload?.addEventListener(ev, e=>{
      e.preventDefault(); e.stopPropagation();
      dzUpload.classList.add('dragover');
    });
  });
  ['dragleave','drop'].forEach(ev=>{
    dzUpload?.addEventListener(ev, e=>{
      e.preventDefault(); e.stopPropagation();
      dzUpload.classList.remove('dragover');
    });
  });

  // Drop
  dzUpload?.addEventListener('drop', e=>{
    if(e.dataTransfer?.files?.length){
      fileReal.files = e.dataTransfer.files;
      showFileMeta(e.dataTransfer.files[0]);
      suggestNameFromFile(e.dataTransfer.files[0]);
    }
  });

  // Selección normal
  fileReal?.addEventListener('change', ()=>{
    if(fileReal.files && fileReal.files[0]){
      showFileMeta(fileReal.files[0]);
      suggestNameFromFile(fileReal.files[0]);
    }
  });

  function showFileMeta(file){
    const mb=(file.size/1024/1024).toFixed(2);
    dzMeta.style.display='block';
    dzMeta.innerHTML = `
      <span><i class="fa fa-file"></i> <strong>${file.name}</strong></span>
      <span style="margin-left:10px;">• ${mb} MB</span>
      <span style="margin-left:10px;">• ${file.type || 'Tipo desconocido'}</span>
    `;
  }

  function slugifyName(name){
    const base = name.replace(/\.[^/.]+$/, '');
    return base.normalize('NFD').replace(/[\u0300-\u036f]/g,'')
              .replace(/[^a-zA-Z0-9_-]+/g,'_')
              .replace(/_+/g,'_')
              .replace(/^_+|_+$/g,'');
  }
  function suggestNameFromFile(file){
    if(!file) return;
    if(!nombreDoc.value){ nombreDoc.value = slugifyName(file.name); }
  }
</script>
{% endblock %}
