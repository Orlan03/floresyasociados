{% extends "base.html" %}
{% load static %}
{% block title %}Nuevo proceso{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

{# Choices.js #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<style>
  :root{
    --navy-900:#071534; --navy-800:#0B1E44; --navy-700:#112759;
    --ink:#EAF0FF; --muted:#9FB0D6; --ink-strong:#ffffff;
    --gold-1:#F7D67B; --gold-2:#DCA94F; --gold-3:#B17B2E;
    --border:rgba(255,255,255,.10); --border-soft:rgba(255,255,255,.08);
    --shadow:0 12px 48px rgba(0,0,0,.35); --rad:16px; --ring:rgba(247,214,123,.32);
    --danger:#ef4444;
  }

  body{ background: radial-gradient(1200px 700px at 20% -10%, #132654 0%, var(--navy-900) 55%); color:var(--ink); }
  .wrap{ max-width:960px; margin:34px auto; padding:0 20px; }

  /* Header */
  .hdr{
    display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px;
    background:linear-gradient(180deg, rgba(11,30,68,.92), rgba(11,30,68,.86));
    border:1px solid var(--border); border-radius:var(--rad); padding:14px 16px; box-shadow:var(--shadow);
  }
  .ttl{ margin:0; color:#fff; font-weight:900; font-size:1.2rem; }
  .crumbs{ color:var(--muted); font-size:.92rem; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .crumbs a{ color:var(--gold-1); text-decoration:none; }
  .crumbs i{ opacity:.7; }

  /* Card / form */
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--border); border-radius:var(--rad); padding:18px; box-shadow:var(--shadow);
  }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:12px; }
  .row > div{ display:flex; flex-direction:column; gap:8px; }
  .span-2{ grid-column:1 / -1; }
  @media (max-width: 820px){ .row{ grid-template-columns:1fr; } }

  label{ font-weight:800; color:#cfe1ff; }
  input, select, textarea{
    border:1px solid var(--border); border-radius:12px; padding:12px 12px;
    background:rgba(255,255,255,.06); color:#fff; width:100%;
    transition:border-color .12s ease, box-shadow .12s ease, background .12s ease;
    color-scheme: dark;
  }
  input::placeholder, textarea::placeholder{ color:#b9c6e4; opacity:.8; }
  input:focus, select:focus, textarea:focus{
    outline:none; border-color:rgba(247,214,123,.45); box-shadow:0 0 0 4px var(--ring);
    background:rgba(255,255,255,.08);
  }
  textarea{ min-height:120px; resize:vertical; }

  .errorlist{
    margin:0; padding:8px 12px; border:1px solid rgba(239,68,68,.35);
    background:rgba(239,68,68,.12); color:#ffe2e2; border-radius:10px; list-style:none; font-size:.92rem;
  }
  .helper{ color:var(--muted); font-size:.92rem; margin-top:-4px; }

  .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
  .btn{
    display:inline-flex; align-items:center; gap:8px; border-radius:12px; padding:10px 14px;
    font-weight:800; text-decoration:none; border:1px solid var(--border);
    background:rgba(255,255,255,.06); color:var(--ink);
    transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
  }
  .btn:hover{ transform:translateY(-1px); background:rgba(255,255,255,.1); box-shadow:0 0 0 4px var(--ring) inset; }
  .btn.primary{ border:0; background:linear-gradient(90deg,var(--gold-1),var(--gold-2)); color:#1a1a1a; box-shadow:0 8px 24px rgba(220,169,79,.25); }
  .btn.primary:hover{ background:linear-gradient(90deg,var(--gold-2),var(--gold-3)); }
  .btn[disabled]{ opacity:.7; cursor:not-allowed; }

  /* ===== Choices.js (tema oscuro + ocultar scrollbar del dropdown) ===== */
  .choices{ background:rgba(255,255,255,.06) !important; border-radius:12px !important; border:1px solid var(--border) !important; color:#fff !important; }
  .choices.is-focused{ border-color:rgba(247,214,123,.45) !important; box-shadow:0 0 0 4px var(--ring) !important; }
  .choices__inner{ background:transparent !important; border:0 !important; color:#fff !important; padding:10px 12px !important; min-height:48px !important; }

  .choices__list--dropdown,
  .choices__list[aria-expanded]{
    background:#0B1E44 !important; border:1px solid var(--border) !important; color:#fff !important;
    box-shadow:0 12px 32px rgba(0,0,0,.45) !important; max-height:320px !important; overflow:auto !important;
    scrollbar-width: none; /* Firefox */
  }
  .choices__list--dropdown::-webkit-scrollbar,
  .choices__list[aria-expanded]::-webkit-scrollbar{ width:0; height:0; } /* WebKit */

  .choices__list--dropdown .choices__item{ color:#fff !important; }
  .choices__list--dropdown .choices__item--selectable.is-highlighted{ background:#132654 !important; }
  .choices__list--dropdown .choices__group{ color:#9FB0D6 !important; }

  .choices__input{
    background:#0B1E44 !important; color:#fff !important; border:0 !important;
    border-bottom:1px solid var(--border) !important; border-radius:0 !important;
  }
  .choices__placeholder{ color:#b9c6e4 !important; opacity:.9 !important; }
  .choices[data-type*="select-one"]::after{ border-color:#cfe1ff transparent transparent transparent !important; }

  /* ===== Modal ===== */
  .modal.hidden{ display:none; }
  .modal{ position:fixed; inset:0; z-index:1000; }
  .modal__backdrop{ position:absolute; inset:0; background:rgba(3,10,24,.72); backdrop-filter: blur(2px); }
  .modal__card{
    position:relative; z-index:1; max-width:520px; margin:10vh auto 0; padding:18px;
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
    border:1px solid var(--border); border-radius:16px; box-shadow: var(--shadow);
  }
  .modal input, .modal select{
    width:100%; background:rgba(255,255,255,.06); color:#fff; border:1px solid var(--border); border-radius:12px; padding:10px 12px;
  }
  .modal input:focus, .modal select:focus{ outline:none; border-color:rgba(247,214,123,.45); box-shadow:0 0 0 4px var(--ring); }
</style>

<div class="wrap">
  <div class="hdr">
    <div>
      <div class="crumbs">
        <a href="{% url 'dashboard' %}">Inicio</a> <i class="fa fa-angle-right"></i>
        <a href="{% url 'procesos:lista' %}">Procesos</a> <i class="fa fa-angle-right"></i>
        <a href="{% url 'procesos:carpeta_detalle' carpeta.id %}">{{ carpeta.nombre }}</a> <i class="fa fa-angle-right"></i>
        <span>Nuevo</span>
      </div>
      <h2 class="ttl">Nuevo proceso en: <span style="color:#F7D67B">{{ carpeta.nombre }}</span></h2>
    </div>
    <a class="btn" href="{% url 'procesos:carpeta_detalle' carpeta.id %}"><i class="fa fa-arrow-left"></i> Volver a carpeta</a>
  </div>

  <div class="card">
    <form method="post" id="proceso-form" novalidate>
      {% csrf_token %}
      {{ form.non_field_errors }}

      <div class="row">
        <div>
          {{ form.nombre.label_tag }} {{ form.nombre }}
          {{ form.nombre.errors }}
        </div>
        <div>
          {{ form.numero_proceso.label_tag }} {{ form.numero_proceso }}
          {{ form.numero_proceso.errors }}
        </div>
      </div>

      <div class="row">
        <div>
          {{ form.estado.label_tag }} {{ form.estado }}
          {{ form.estado.errors }}
        </div>
        <div>
          {{ form.fecha_revision.label_tag }} {{ form.fecha_revision }}
          {{ form.fecha_revision.errors }}
        </div>
      </div>

      <div class="row">
        <div>
          {{ form.ciudad.label_tag }} {{ form.ciudad }}
          {{ form.ciudad.errors }}
        </div>
        <div class="span-2">
          {{ form.observacion.label_tag }} {{ form.observacion }}
          {{ form.observacion.errors }}
        </div>
      </div>

      {# Selector + botón para crear carpeta #}
      <div class="row">
        <div class="span-2">
          <label for="id_carpeta_doc_padre">Carpeta de Documentos (padre)</label>
          <div style="display:flex; gap:10px; align-items:center;">
            {{ form.carpeta_doc_padre }}
            <button type="button" class="btn" id="btn-nueva-carpeta" title="Crear nueva carpeta">
              <i class="fa fa-folder-plus"></i> Nueva carpeta
            </button>
          </div>
          <div class="helper">{{ form.carpeta_doc_padre.help_text }}</div>
          {{ form.carpeta_doc_padre.errors }}
        </div>
      </div>

      <div class="actions">
        <a class="btn" href="{% url 'procesos:carpeta_detalle' carpeta.id %}"><i class="fa fa-xmark"></i> Cancelar</a>
        <button type="submit" class="btn primary" id="btn-guardar"><i class="fa fa-save"></i> Guardar</button>
      </div>
    </form>
  </div>
</div>

{# ==== MODAL CREAR CARPETA ==== #}
<div id="modal-nueva-carpeta" class="modal hidden" aria-hidden="true">
  <div class="modal__backdrop"></div>
  <div class="modal__card">
    <h3 style="margin:0 0 8px; color:#fff;">Nueva carpeta de Documentos</h3>
    <p class="helper" style="margin-top:0;">Puedes crearla en la raíz o dentro de la carpeta actualmente seleccionada.</p>

    <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
      <div>
        <label for="nc_nombre">Nombre</label>
        <input id="nc_nombre" type="text" placeholder="Ej.: PROCESOS TRIBUTARIOS" />
      </div>
      <div>
        <label for="nc_modo">Ubicación</label>
        <select id="nc_modo">
          <option value="root">Raíz de Documentos</option>
          <option value="selected">Dentro de la carpeta seleccionada</option>
        </select>
        <small class="helper">Si no hay carpeta seleccionada, se creará en raíz.</small>
      </div>
    </div>

    <div class="actions" style="margin-top:14px;">
      <button type="button" class="btn" id="nc_cancelar"><i class="fa fa-xmark"></i> Cancelar</button>
      <button type="button" class="btn primary" id="nc_crear"><i class="fa fa-check"></i> Crear</button>
    </div>
  </div>
</div>

<script>
  // === Choices para select de carpeta y estado ===
  let choicesCarpeta = null;

  (function(){
    const configDark = {
      shouldSort: false,
      itemSelectText: '',
      allowHTML: false,
      searchPlaceholderValue: 'Buscar…',
    };
    const idCarpeta = document.getElementById("id_carpeta_doc_padre");
    if (idCarpeta) choicesCarpeta = new Choices(idCarpeta, configDark);

    const idEstado = document.getElementById("id_estado");
    if (idEstado) new Choices(idEstado, { ...configDark, searchEnabled: false });
  })();

  // === Modal Nueva Carpeta ===
  (function(){
    const modal = document.getElementById('modal-nueva-carpeta');
    const btnOpen = document.getElementById('btn-nueva-carpeta');
    const btnCreate = document.getElementById('nc_crear');
    const btnCancel = document.getElementById('nc_cancelar');
    const inpNombre = document.getElementById('nc_nombre');
    const selModo   = document.getElementById('nc_modo');
    const selectEl  = document.getElementById('id_carpeta_doc_padre');

    function openModal(){ modal.classList.remove('hidden'); inpNombre.value = ''; inpNombre.focus(); }
    function closeModal(){ modal.classList.add('hidden'); }

    btnOpen.addEventListener('click', openModal);
    btnCancel.addEventListener('click', closeModal);
    modal.querySelector('.modal__backdrop').addEventListener('click', closeModal);

    btnCreate.addEventListener('click', async function(){
      const nombre = (inpNombre.value || '').trim();
      if (!nombre){ inpNombre.focus(); return; }

      // Si no hay selección y modo es "selected", forzamos root
      let padreId = null;
      if (selModo.value === 'selected') {
        const current = selectEl.value;
        if (current && current !== '') padreId = current;
        else selModo.value = 'root';
      }

      // CSRF
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      // Llamada a la API
      const resp = await fetch("{% url 'procesos:api_carpeta_doc_crear' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify({ nombre: nombre, modo: selModo.value, padre_id: padreId })
      });

      const data = await resp.json();
      if (!resp.ok || !data.ok) {
        alert(data.error || "No se pudo crear la carpeta.");
        return;
      }

      // Agregar la nueva opción y seleccionarla
      const newChoice = [{ value: String(data.id), label: data.nombre, selected: true }];
      if (choicesCarpeta) {
        choicesCarpeta.setChoices(newChoice, 'value', 'label', false);
        choicesCarpeta.setChoiceByValue(String(data.id));
      } else {
        const opt = document.createElement('option');
        opt.value = data.id; opt.textContent = data.nombre; opt.selected = true;
        selectEl.appendChild(opt);
      }

      closeModal();
    });
  })();

  // === Botón "Guardando…" (previene doble submit) ===
  (function(){
    const form = document.getElementById('proceso-form');
    const btn  = document.getElementById('btn-guardar');
    form.addEventListener('submit', function(e){
      if (form.dataset.submitted === "true") { e.preventDefault(); return; }
      form.dataset.submitted = "true";
      btn.setAttribute('disabled', 'disabled');
      btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Guardando…';
    });
  })();
</script>
{% endblock %}
