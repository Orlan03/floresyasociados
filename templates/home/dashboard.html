{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard - Flores y Asociados{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
  :root{
    --navy-900:#071534; --navy-800:#0B1E44; --navy-700:#112759;
    --ink:#EAF0FF; --muted:#9FB0D6;
    --gold-1:#F7D67B; --gold-2:#DCA94F; --gold-3:#B17B2E;
    --ring:rgba(247,214,123,.32);
    --border:rgba(255,255,255,.08);
    --shadow:0 10px 40px rgba(0,0,0,.35);
    --rad:16px;
  }
  body{ background: radial-gradient(1200px 700px at 20% -10%, #132654 0%, var(--navy-900) 55%); color: var(--ink); }
  .wrap{ max-width:1180px; margin:40px auto; padding:0 22px; }

  .hdr{
    background: linear-gradient(180deg, var(--navy-800), rgba(11,30,68,.96));
    border:1px solid var(--border);
    border-radius: var(--rad);
    padding:18px 22px;
    box-shadow: var(--shadow);
    display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:26px;
  }
  .brand{ display:flex; align-items:center; gap:14px; }
  .brand .logo{
    width:70px; height:70px; border-radius:14px;
    background: radial-gradient(50% 60% at 30% 20%, rgba(255,255,255,.06), transparent 60%);
    display:grid; place-items:center; border:1px solid var(--border);
  }
  .brand .logo img{ width:58px; height:58px; object-fit:contain; filter: drop-shadow(0 6px 14px rgba(0,0,0,.35)); }
  .brand h1{ margin:0; font-weight:800; letter-spacing:.2px; color:#ffffff; }
  .brand .sub{ color: var(--muted); font-size:.95rem; margin-top:4px; }

  .btn{
    appearance:none; border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer;
    display:inline-flex; align-items:center; gap:8px; text-decoration:none;
    border:1px solid var(--border); color:var(--ink); background:rgba(255,255,255,.02);
    transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
  }
  .btn:hover{ transform: translateY(-1px); background:rgba(255,255,255,.04); box-shadow: 0 0 0 4px var(--ring) inset; }
  .btn-primary{
    border:0; background: linear-gradient(90deg, var(--gold-1), var(--gold-2));
    color:#1a1a1a; box-shadow: 0 8px 24px rgba(220,169,79,.25);
  }
  .btn-primary:hover{ background: linear-gradient(90deg, var(--gold-2), var(--gold-3)); }

  .grid{ display:grid; gap:18px; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); }
  .card{
    position:relative;
    background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    border:1px solid var(--border);
    border-radius: var(--rad);
    padding:18px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .card::after{
    content:""; position:absolute; inset:auto -40% -40% auto; width:240px; height:240px; border-radius:50%;
    background: radial-gradient(closest-side, rgba(247,214,123,.15), transparent 70%);
    transform: translate(30%, 30%);
    pointer-events:none;
  }
  .card:hover{ transform: translateY(-2px); }
  .top{ display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
  .ico{
    width:44px; height:44px; border-radius:12px; display:grid; place-items:center;
    background: radial-gradient(60% 60% at 30% 30%, rgba(255,255,255,.25), rgba(255,255,255,.06));
    border:1px solid var(--border); color: var(--gold-1);
  }
  .ico-sm{
    width:40px; height:40px; border-radius:12px; display:grid; place-items:center;
    background: radial-gradient(60% 60% at 30% 30%, rgba(255,255,255,.25), rgba(255,255,255,.06));
    border:1px solid var(--border); color: var(--gold-1);
  }
  .card h3{ margin:0; font-size:1.06rem; font-weight:800; color:#fff; }
  .num{ font-size:2.3rem; font-weight:900; color:var(--gold-1); line-height:1; }
  .muted{ color:var(--muted); font-size:.95rem; }
  .linkcard{ text-decoration:none; color:inherit; display:block; }
  .linkcard .muted{ margin-top:6px; }

  .notice-card{
    background:linear-gradient(180deg, rgba(247,214,123,.14), rgba(247,214,123,.08));
    border:1px solid rgba(247,214,123,.40);
    border-radius: var(--rad);
    padding:16px 18px;
    box-shadow: var(--shadow);
    margin-bottom:22px;
  }
  .notice-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
  .notice-left{ display:flex; align-items:center; gap:10px; }
  .notice-title{ font-weight:900; color:var(--gold-1); font-size:1.08rem; letter-spacing:.2px; }
  .badge-count{
    background:rgba(247,214,123,.18); color:var(--gold-1);
    border:1px solid rgba(247,214,123,.35); border-radius:999px; padding:6px 10px; font-weight:900; font-size:.9rem;
  }
  .notice-list{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:10px; }
  .notice-item{
    display:flex; gap:10px; align-items:flex-start;
    background: rgba(255,255,255,.02); border:1px solid var(--border);
    padding:10px 12px; border-radius:12px;
  }
  .notice-item i{ color:var(--gold-1); margin-top:2px; }
  .notice-link{ color:var(--gold-1); text-decoration:underline; font-weight:800; }
  .pill{ margin-left:8px; font-size:.75rem; padding:2px 8px; border-radius:999px; font-weight:800; }
  .pill-soon{ background:rgba(247,214,123,.18); color:var(--gold-1); border:1px solid rgba(247,214,123,.4); }
  .pill-overdue{ background:rgba(220,38,38,.18); color:#ffbdbd; border:1px solid rgba(220,38,38,.35); }
</style>

<div class="wrap">
  <!-- Header -->
  <div class="hdr">
    <div class="brand">
      <div class="logo">
        <img src="{% static 'img/logo.jpg' %}" alt="Logo">
      </div>
      <div>
        <h1>Bienvenido, {{ request.user.first_name|default:request.user.get_username }}</h1>
        <div class="sub">Flores y Asociados Â· Panel principal</div>
      </div>
    </div>
    <div class="actions">
      {% if request.user.is_superuser %}
        <a class="btn btn-primary" href="{% url 'cuentas:crear_usuario_simple' %}">
          <i class="fa fa-user-plus"></i> Crear usuario
        </a>
        <a class="btn" href="{% url 'cuentas:lista_usuarios' %}">
          <i class="fa fa-users"></i> Lista de usuarios
        </a>
      {% endif %}
      <form action="{% url 'logout' %}" method="post" style="display:inline;">
        {% csrf_token %}
        <button class="btn btn-primary" type="submit"><i class="fa fa-right-from-bracket"></i> Cerrar sesiÃ³n</button>
      </form>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid">
    <div class="card">
      <div class="top">
        <h3>Usuarios registrados</h3>
        <div class="ico"><i class="fa fa-users"></i></div>
      </div>
      <div class="num">{{ total_usuarios }}</div>
      <div class="muted" style="margin-top:6px;">Administrados por el superusuario</div>
    </div>

    <a href="{{ url_tabla_procesos }}" class="card linkcard">
      <div class="top">
        <h3>Listado de procesos</h3>
        <div class="ico"><i class="fa fa-scale-balanced"></i></div>
      </div>
      <div class="num">{{ total_procesos|default:"â€”" }}</div>
      <div class="muted">Ir al gestor de carpetas de procesos</div>
    </a>

    <a href="{% url 'procesos:documentos_lista' %}" class="card linkcard">
      <div class="top">
        <h3>Documentos</h3>
        <div class="ico"><i class="fa fa-folder"></i></div>
      </div>
      <div class="muted">Gestiona carpetas y archivos</div>
    </a>
  </div>

  {% with n1=avisos_revision|length n2=vencidos_revision|length %}
    {% with total_alertas=n1|add:n2 %}
      {% if total_alertas %}
        <div class="notice-card">
          <div class="notice-head">
            <div class="notice-left">
              <div class="ico-sm"><i class="fa fa-triangle-exclamation"></i></div>
              <div class="notice-title">AtenciÃ³n</div>
            </div>
            <div class="badge-count">{{ total_alertas }} alerta{{ total_alertas|pluralize:"s" }}</div>
          </div>

          <ul class="notice-list">
            {% for p in avisos_revision %}
              <li class="notice-item">
                <i class="fa fa-circle-dot"></i>
                <div>
                  El proceso
                  <a class="notice-link" href="{% url 'procesos:proceso_detalle' p.pk %}">
                    "{{ p.numero_proceso|default:p.nombre }}"
                  </a>
                  vence el <b>{{ p.fecha_revision|date:"d/m/Y" }}</b>.
                  Responsable: <b>{{ p.creado_por.get_username|default:"â€”" }}</b>
                  {% if p.carpeta_documentos_id %} â€“ <a class="notice-link" href="{% url 'procesos:carpeta_detalle' p.carpeta_documentos_id %}">ðŸ“‚ Carpeta</a>{% endif %}
                  <span class="pill pill-soon">
                    {% now "Y-m-d" as hoystr %}
                    {% if p.fecha_revision|date:"Y-m-d" == hoystr %}Hoy{% else %}PrÃ³ximo{% endif %}
                  </span>
                </div>
              </li>
            {% endfor %}

            {% for p in vencidos_revision %}
              <li class="notice-item">
                <i class="fa fa-circle-exclamation"></i>
                <div>
                  El proceso
                  <a class="notice-link" href="{% url 'procesos:proceso_detalle' p.pk %}">
                    "{{ p.numero_proceso|default:p.nombre }}"
                  </a>
                  venciÃ³ el <b>{{ p.fecha_revision|date:"d/m/Y" }}</b>.
                  Responsable: <b>{{ p.creado_por.get_username|default:"â€”" }}</b>
                  {% if p.carpeta_documentos_id %} â€“ <a class="notice-link" href="{% url 'procesos:carpeta_detalle' p.carpeta_documentos_id %}">ðŸ“‚ Carpeta</a>{% endif %}
                  <span class="pill pill-overdue">Vencido</span>
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    {% endwith %}
  {% endwith %}
</div>
{% endblock %}
